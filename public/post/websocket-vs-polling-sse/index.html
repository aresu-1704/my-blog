<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Phân tích sâu về cơ chế WebSocket, HTTP Polling và Server-Sent Events từ góc nhìn tầng mạng. Hiểu rõ quá trình bắt tay, kết nối song công toàn phần và cách chọn công nghệ phù hợp cho ứng dụng thời gian thực"
    />
    <title>
      WebSocket hoạt động ra sao ở tầng mạng? So sánh với HTTP Polling và SSE - THUẬN AN IT BLOG
    </title>

    
    
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    

    
    <script src="https://cdn.tailwindcss.com"></script>

    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
              },
            },
          },
        },
      };
    </script>

    
     
    <link rel="stylesheet" href="/css/main.min.96a535f2c9e6b011f54cdd8701868801ab256ec3404f1d1873675f82f8f961cb.css" />
    
  </head>
  <body class="bg-slate-900 text-gray-100">
    
    
<nav class="bg-slate-950 border-b border-slate-800 shadow-lg sticky top-0 z-50">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-between h-16">
      
      <div class="flex items-center gap-3">
        
        <img
          src="/icon/icon.png"
          alt="Blog Icon"
          class="w-10 h-10 rounded-lg"
        />

        
        <div>
          <a
            href="/"
            class="text-xl font-bold text-cyan-400 hover:text-cyan-300 transition-colors block"
          >
            THUẬN AN IT BLOG
          </a>
          <p class="text-xs text-gray-400">
            Blog chia sẻ kiến thức về lập trình & AI
          </p>
        </div>
      </div>

      
      <div class="hidden md:flex items-center space-x-6">
        
        <a
          href="/"
          class="text-gray-300 hover:text-cyan-400 transition-colors font-medium text-sm"
        >
          Home
        </a>

        
        
        <a
          href="/research/"
          class="text-gray-300 hover:text-cyan-400 transition-colors font-medium text-sm"
        >
          Research
        </a>
        
        <a
          href="/portfolio/"
          class="text-gray-300 hover:text-cyan-400 transition-colors font-medium text-sm"
        >
          Portfolio
        </a>
        
        <a
          href="/about/"
          class="text-gray-300 hover:text-cyan-400 transition-colors font-medium text-sm"
        >
          About
        </a>
        
        <a
          href="/contact/"
          class="text-gray-300 hover:text-cyan-400 transition-colors font-medium text-sm"
        >
          Contact
        </a>
        

        
        <div class="relative group">
          <button
            class="text-gray-300 hover:text-cyan-400 transition-colors font-medium flex items-center text-sm"
          >
            Categories
            <svg
              class="w-4 h-4 ml-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </button>

          
          <div
            class="absolute left-0 mt-2 w-48 bg-slate-800 border border-slate-700 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200"
          >
            <div class="py-2">
              
              <a
                href="//localhost:1313/categories/backend/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors text-sm"
              >
                Backend
                <span class="text-gray-500 text-xs">(1)</span>
              </a>
              
              <a
                href="//localhost:1313/categories/java/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors text-sm"
              >
                Java
                <span class="text-gray-500 text-xs">(6)</span>
              </a>
              
              <a
                href="//localhost:1313/categories/javascript/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors text-sm"
              >
                JavaScript
                <span class="text-gray-500 text-xs">(3)</span>
              </a>
              
              <a
                href="//localhost:1313/categories/network/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors text-sm"
              >
                Network
                <span class="text-gray-500 text-xs">(2)</span>
              </a>
              
              <a
                href="//localhost:1313/categories/network-programming/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors text-sm"
              >
                Network Programming
                <span class="text-gray-500 text-xs">(2)</span>
              </a>
              
              <a
                href="//localhost:1313/categories/networking/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors text-sm"
              >
                Networking
                <span class="text-gray-500 text-xs">(4)</span>
              </a>
              
              <a
                href="//localhost:1313/categories/programming/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors text-sm"
              >
                Programming
                <span class="text-gray-500 text-xs">(4)</span>
              </a>
              
              <a
                href="//localhost:1313/categories/security/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors text-sm"
              >
                Security
                <span class="text-gray-500 text-xs">(1)</span>
              </a>
              
              <a
                href="//localhost:1313/categories/system-design/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors text-sm"
              >
                System Design
                <span class="text-gray-500 text-xs">(1)</span>
              </a>
              
              <a
                href="//localhost:1313/categories/web-development/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors text-sm"
              >
                Web Development
                <span class="text-gray-500 text-xs">(1)</span>
              </a>
              
              <a
                href="//localhost:1313/categories/web-security/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors text-sm"
              >
                Web Security
                <span class="text-gray-500 text-xs">(1)</span>
              </a>
              
            </div>
          </div>
        </div>
      </div>

      
      <button
        id="mobile-menu-button"
        class="md:hidden text-gray-300 hover:text-cyan-400 focus:outline-none"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"
          ></path>
        </svg>
      </button>
    </div>

    
    <div id="mobile-menu" class="hidden md:hidden pb-4">
      <a
        href="/"
        class="block py-2 text-gray-300 hover:text-cyan-400 transition-colors font-medium"
      >
        Home
      </a>

      
      
      <a
        href="/research/"
        class="block py-2 text-gray-300 hover:text-cyan-400 transition-colors font-medium"
      >
        Research
      </a>
      
      <a
        href="/portfolio/"
        class="block py-2 text-gray-300 hover:text-cyan-400 transition-colors font-medium"
      >
        Portfolio
      </a>
      
      <a
        href="/about/"
        class="block py-2 text-gray-300 hover:text-cyan-400 transition-colors font-medium"
      >
        About
      </a>
      
      <a
        href="/contact/"
        class="block py-2 text-gray-300 hover:text-cyan-400 transition-colors font-medium"
      >
        Contact
      </a>
      

      <div class="py-2">
        <div class="font-medium text-white mb-2">Categories:</div>
        
        <a
          href="//localhost:1313/categories/backend/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Backend
          <span class="text-gray-500 text-sm">(1)</span>
        </a>
        
        <a
          href="//localhost:1313/categories/java/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Java
          <span class="text-gray-500 text-sm">(6)</span>
        </a>
        
        <a
          href="//localhost:1313/categories/javascript/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          JavaScript
          <span class="text-gray-500 text-sm">(3)</span>
        </a>
        
        <a
          href="//localhost:1313/categories/network/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Network
          <span class="text-gray-500 text-sm">(2)</span>
        </a>
        
        <a
          href="//localhost:1313/categories/network-programming/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Network Programming
          <span class="text-gray-500 text-sm">(2)</span>
        </a>
        
        <a
          href="//localhost:1313/categories/networking/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Networking
          <span class="text-gray-500 text-sm">(4)</span>
        </a>
        
        <a
          href="//localhost:1313/categories/programming/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Programming
          <span class="text-gray-500 text-sm">(4)</span>
        </a>
        
        <a
          href="//localhost:1313/categories/security/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Security
          <span class="text-gray-500 text-sm">(1)</span>
        </a>
        
        <a
          href="//localhost:1313/categories/system-design/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          System Design
          <span class="text-gray-500 text-sm">(1)</span>
        </a>
        
        <a
          href="//localhost:1313/categories/web-development/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Web Development
          <span class="text-gray-500 text-sm">(1)</span>
        </a>
        
        <a
          href="//localhost:1313/categories/web-security/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Web Security
          <span class="text-gray-500 text-sm">(1)</span>
        </a>
        
      </div>
    </div>
  </div>
</nav>


<script>
  document
    .getElementById("mobile-menu-button")
    .addEventListener("click", function () {
      const menu = document.getElementById("mobile-menu");
      menu.classList.toggle("hidden");
    });
</script>


    
    <main class="min-h-screen">
<div class="container mx-auto px-4 py-8">
  <div class="grid grid-cols-1 lg:grid-cols-10 gap-8">
    
    <div class="lg:col-span-7">
      <article
        class="bg-slate-800 border border-slate-700 rounded-lg shadow-lg p-8"
      >
        
        <header class="mb-8">
          
          
          <div class="mb-6 -mx-8 -mt-8">
            <img
              src="/images/websocket.jpg"
              alt="WebSocket hoạt động ra sao ở tầng mạng? So sánh với HTTP Polling và SSE"
              class="w-full h-96 object-cover rounded-t-lg"
            />
          </div>
          

          <h1 class="text-4xl font-bold mb-4 text-white">WebSocket hoạt động ra sao ở tầng mạng? So sánh với HTTP Polling và SSE</h1>

          <div
            class="flex flex-wrap items-center gap-4 text-sm text-gray-400 mb-4"
          >
            
            <span class="flex items-center">
              <svg
                class="w-4 h-4 mr-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                ></path>
              </svg>
              22/12/2025
            </span>

            
            
          </div>

          
          
          <div class="flex flex-wrap gap-2 mb-4">
            
            <a
              href="/categories/network-programming"
              class="px-3 py-1 bg-cyan-900 bg-opacity-30 text-cyan-300 border border-cyan-600 rounded-full text-sm hover:bg-cyan-800 hover:bg-opacity-40 transition-colors"
            >
              Network Programming
            </a>
            
            <a
              href="/categories/web-development"
              class="px-3 py-1 bg-cyan-900 bg-opacity-30 text-cyan-300 border border-cyan-600 rounded-full text-sm hover:bg-cyan-800 hover:bg-opacity-40 transition-colors"
            >
              Web Development
            </a>
            
          </div>
          

          
          
          <div class="flex flex-wrap gap-2">
            
            <a
              href="/tags/websocket"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #WebSocket
            </a>
            
            <a
              href="/tags/http"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #HTTP
            </a>
            
            <a
              href="/tags/sse"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #SSE
            </a>
            
            <a
              href="/tags/realtime"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #Realtime
            </a>
            
            <a
              href="/tags/network"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #Network
            </a>
            
            <a
              href="/tags/javascript"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #JavaScript
            </a>
            
            <a
              href="/tags/node.js"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #Node.js
            </a>
            
          </div>
          
        </header>

        
        <div
          class="prose prose-invert max-w-none prose-headings:font-bold prose-headings:text-white prose-a:text-cyan-400 prose-a:no-underline hover:prose-a:underline prose-img:rounded-lg prose-pre:bg-slate-950 prose-pre:border prose-pre:border-slate-700 prose-code:text-cyan-300 text-gray-300"
        >
          <h2 id="http-truyền-thống-và-bài-toán-thời-gian-thực">HTTP truyền thống và bài toán thời gian thực</h2>
<p>Khi mới bắt đầu làm ứng dụng chat, điều đầu tiên nghĩ đến là dùng HTTP yêu cầu-phản hồi thông thường. Client cứ 2 giây lại gửi một yêu cầu lên server hỏi &ldquo;có tin nhắn mới không?&rdquo;. Server trả về danh sách tin nhắn mới nếu có, hoặc trả về mảng rỗng nếu không. Nghe có vẻ hợp lý, nhưng khi chạy thực tế thì thấy ngay vấn đề.</p>
<p>HTTP được thiết kế theo mô hình yêu cầu-phản hồi. Client phải khởi tạo mọi giao tiếp. Server không thể tự ý gửi dữ liệu xuống client khi có sự kiện mới. Điều này hoàn toàn ổn với website thông thường, nhưng với ứng dụng thời gian thực như chat, thông báo, bảng điều khiển trực tiếp thì lại là một vấn đề lớn. Người dùng gửi tin nhắn đến, nhưng phải đợi đến khi client gửi yêu cầu tiếp theo mới nhận được. Độ trễ này có thể từ vài trăm mili giây đến vài giây tùy thuộc vào khoảng thời gian thăm dò.</p>
<h2 id="http-polling---giải-pháp-tình-thế-đầu-tiên">HTTP Polling - Giải pháp tình thế đầu tiên</h2>
<p>HTTP Polling chính là cách vừa mô tả. Client liên tục gửi yêu cầu lên server theo một khoảng thời gian cố định, ví dụ mỗi 2 giây. Mỗi lần gửi yêu cầu, nó hỏi server &ldquo;có cập nhật không?&rdquo;. Nếu có dữ liệu mới, server trả về. Nếu không, server trả về phản hồi rỗng.</p>
<p>Vấn đề lớn nhất của thăm dò chính là chi phí phụ khủng khiếp. Mỗi yêu cầu HTTP bao gồm bắt tay TCP nếu kết nối không được tái sử dụng, các HTTP headers, và thời gian xử lý ở cả client lẫn server. Nếu có 10,000 người dùng và mỗi người thăm dò mỗi 2 giây, đó là 5,000 yêu cầu mỗi giây đập vào server, trong khi 99% yêu cầu đó trả về phản hồi rỗng vì không có dữ liệu mới.</p>
<p>Trường hợp thử nghiệm thăm dò cho một ứng dụng chat nhỏ với khoảng 100 người dùng đồng thời. Server CPU liên tục ở mức 40-50% chỉ để xử lý những yêu cầu không có gì. Băng thông mạng cũng bị lãng phí vì HTTP headers thường lớn hơn dữ liệu thực nhiều lần. Phần đầu yêu cầu có thể 500 bytes trong khi phản hồi chỉ là <code>{&quot;messages&quot;: []}</code> (18 bytes).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Client-side polling - cách làm tốn kém
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">startPolling</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setInterval</span>(<span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#34;/api/messages&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">json</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">messages</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">updateUI</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">messages</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }, <span style="color:#ae81ff">2000</span>); <span style="color:#75715e">// Thăm dò mỗi 2 giây
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h2 id="long-polling---cải-thiện-nhưng-vẫn-tạm-bợ">Long Polling - Cải thiện nhưng vẫn tạm bợ</h2>
<p>Long Polling ra đời như một cải tiến của Polling. Thay vì server trả về ngay lập tức, server giữ yêu cầu trong trạng thái chờ cho đến khi có dữ liệu mới hoặc hết thời gian chờ. Khi có sự kiện xảy ra, server mới phản hồi và đóng kết nối. Client nhận phản hồi, xử lý dữ liệu, rồi ngay lập tức tạo yêu cầu mới.</p>
<p>Cơ chế này giảm số lượng yêu cầu đáng kể so với thăm dò thông thường. Thay vì 5,000 yêu cầu/giây với 10,000 người dùng, giờ chỉ có yêu cầu khi thực sự có sự kiện. Tuy nhiên, Long Polling vẫn có những hạn chế nghiêm trọng.</p>
<p>Mỗi yêu cầu đang chờ chiếm giữ một thread hoặc kết nối ở server. Với mô hình một thread cho một yêu cầu như Java Servlets truyền thống, 10,000 người dùng đồng thời nghĩa là 10,000 threads đang chờ, tiêu tốn bộ nhớ và chi phí chuyển ngữ cảnh. Hơn nữa, kết nối vẫn bị đóng và mở lại liên tục, không thực sự bền vững.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Client-side long polling
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">longPoll</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#34;/api/messages?timeout=30000&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">json</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">messages</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">updateUI</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">messages</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Lỗi thăm dò:&#34;</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Ngay lập tức tạo yêu cầu mới
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">longPoll</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">longPoll</span>();
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// Server-side long polling với Java</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@WebServlet</span>(<span style="color:#e6db74">&#34;/api/messages&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessagesServlet</span> <span style="color:#66d9ef">extends</span> HttpServlet {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> TIMEOUT <span style="color:#f92672">=</span> 30000;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doGet</span>(HttpServletRequest req, HttpServletResponse resp) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> startTime <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">currentTimeMillis</span>();
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>Message<span style="color:#f92672">&gt;</span> messages <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Chờ cho đến khi có tin nhắn hoặc hết thời gian</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (System.<span style="color:#a6e22e">currentTimeMillis</span>() <span style="color:#f92672">-</span> startTime <span style="color:#f92672">&lt;</span> TIMEOUT) {
</span></span><span style="display:flex;"><span>            messages <span style="color:#f92672">=</span> messageQueue.<span style="color:#a6e22e">poll</span>(userId);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>messages.<span style="color:#a6e22e">isEmpty</span>()) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#a6e22e">sleep</span>(100); <span style="color:#75715e">// Đợi 100ms rồi kiểm tra lại</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        resp.<span style="color:#a6e22e">setContentType</span>(<span style="color:#e6db74">&#34;application/json&#34;</span>);
</span></span><span style="display:flex;"><span>        resp.<span style="color:#a6e22e">getWriter</span>().<span style="color:#a6e22e">write</span>(gson.<span style="color:#a6e22e">toJson</span>(messages));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="server-sent-events---một-chiều-nhưng-hiệu-quả">Server-Sent Events - Một chiều nhưng hiệu quả</h2>
<p>SSE (Server-Sent Events) là một bước tiến đáng kể, nhưng lại ít người biết đến. SSE cho phép server đẩy dữ liệu xuống client qua một kết nối HTTP duy nhất, bền vững. Khác với thăm dò, kết nối được giữ mở và server có thể gửi sự kiện bất kỳ lúc nào.</p>
<p>Điểm hay của SSE là nó vô cùng đơn giản. Client chỉ cần tạo một đối tượng <code>EventSource</code>, và server chỉ cần đặt header <code>Content-Type: text/event-stream</code> rồi gửi dữ liệu theo định dạng đặc biệt. Trình duyệt tự động xử lý kết nối lại nếu kết nối bị đứt.</p>
<p>Tuy nhiên, SSE có một hạn chế lớn: nó chỉ là giao tiếp một chiều. Server có thể đẩy dữ liệu xuống client, nhưng client muốn gửi dữ liệu lên server thì vẫn phải tạo yêu cầu HTTP riêng. Điều này ổn với các trường hợp như thông báo trực tiếp hay cập nhật giá cổ phiếu (nơi client chỉ cần nhận dữ liệu), nhưng không phù hợp với chat hoặc chỉnh sửa cộng tác (nơi cần giao tiếp hai chiều liên tục).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Client-side SSE - cực kỳ đơn giản
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">eventSource</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">EventSource</span>(<span style="color:#e6db74">&#34;/api/events&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">eventSource</span>.<span style="color:#a6e22e">onmessage</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">event</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">updateUI</span>(<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">eventSource</span>.<span style="color:#a6e22e">onerror</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">error</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Lỗi SSE:&#34;</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Trình duyệt tự động kết nối lại
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Server-side SSE với Node.js
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;/api/events&#34;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">setHeader</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#e6db74">&#34;text/event-stream&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">setHeader</span>(<span style="color:#e6db74">&#34;Cache-Control&#34;</span>, <span style="color:#e6db74">&#34;no-cache&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">setHeader</span>(<span style="color:#e6db74">&#34;Connection&#34;</span>, <span style="color:#e6db74">&#34;keep-alive&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Gửi sự kiện định kỳ hoặc khi có dữ liệu mới
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sendEvent</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">data</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">write</span>(<span style="color:#e6db74">`data: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">data</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">\\n\\n`</span>);
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Lắng nghe sự kiện và đẩy xuống client
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">eventEmitter</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;newMessage&#34;</span>, <span style="color:#a6e22e">sendEvent</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;close&#34;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">eventEmitter</span>.<span style="color:#a6e22e">off</span>(<span style="color:#e6db74">&#34;newMessage&#34;</span>, <span style="color:#a6e22e">sendEvent</span>);
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><h2 id="websocket---kết-nối-song-công-toàn-phần-thực-sự">WebSocket - Kết nối song công toàn phần thực sự</h2>
<p>WebSocket là bước ngoặt. Thay vì lợi dụng HTTP để tạo ra kết nối bền vững, WebSocket thiết kế lại từ đầu cho giao tiếp thời gian thực. Nó bắt đầu như một yêu cầu HTTP, nhưng sau quá trình bắt tay thành công, kết nối được nâng cấp thành một socket TCP thuần túy, chạy trên chính kết nối TCP đó.</p>
<p>Quá trình bắt tay của WebSocket khá thú vị. Client gửi một yêu cầu HTTP GET với header đặc biệt <code>Upgrade: websocket</code> và <code>Connection: Upgrade</code>. Yêu cầu này còn bao gồm một <code>Sec-WebSocket-Key</code> được client tạo ngẫu nhiên. Server nhận yêu cầu, xác thực headers, tính toán <code>Sec-WebSocket-Accept</code> bằng cách băm <code>Sec-WebSocket-Key</code> với một chuỗi ma thuật cố định theo đặc tả, rồi trả về HTTP 101 Switching Protocols.</p>
<pre tabindex="0"><code>GET /chat HTTP/1.1
Host: example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13
</code></pre><p>Phản hồi của server:</p>
<pre tabindex="0"><code>HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
</code></pre><p>Sau quá trình bắt tay này, giao thức HTTP chấm dứt. Kết nối TCP vẫn mở nhưng giờ dữ liệu được gửi theo giao thức đóng khung WebSocket. Không còn HTTP headers, không còn mô hình yêu cầu-phản hồi. Cả client và server đều có thể gửi dữ liệu bất kỳ lúc nào mà không cần đợi phía kia khởi tạo.</p>
<p>Đây chính là ý nghĩa của song công toàn phần. Ở tầng mạng, TCP vốn đã là song công toàn phần (dữ liệu có thể chảy cả hai chiều đồng thời), nhưng HTTP lại áp đặt mô hình yêu cầu-phản hồi lên nó. WebSocket gỡ bỏ giới hạn đó, cho phép tầng ứng dụng tận dụng hết khả năng của TCP.</p>
<p>Mỗi tin nhắn trong WebSocket được đóng gói trong các khung nhỏ. Phần đầu khung chỉ 2-14 bytes tùy kích thước dữ liệu tải, vô cùng nhẹ so với HTTP headers hàng trăm bytes. Đối với tin nhắn nhỏ như tin nhắn chat, chi phí phụ giảm từ 80-90% xuống còn vài phần trăm.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Client-side WebSocket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ws</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebSocket</span>(<span style="color:#e6db74">&#34;ws://localhost:8080/chat&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">onopen</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Đã kết nối&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({ <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;join&#34;</span>, <span style="color:#a6e22e">room</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;general&#34;</span> }));
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">onmessage</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">event</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">message</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">updateUI</span>(<span style="color:#a6e22e">message</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">onerror</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">error</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Lỗi WebSocket:&#34;</span>, <span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">onclose</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Kết nối đã đóng&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Tự kết nối lại nếu cần
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Gửi tin nhắn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sendMessage</span>(<span style="color:#a6e22e">text</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({ <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;message&#34;</span>, <span style="color:#a6e22e">text</span> }));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Server-side WebSocket với Node.js và thư viện ws
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">WebSocket</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;ws&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wss</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebSocket</span>.<span style="color:#a6e22e">Server</span>({ <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">8080</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wss</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;connection&#34;</span>, (<span style="color:#a6e22e">ws</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Client đã kết nối&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;message&#34;</span>, (<span style="color:#a6e22e">data</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">message</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Phát tới tất cả clients
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">wss</span>.<span style="color:#a6e22e">clients</span>.<span style="color:#a6e22e">forEach</span>((<span style="color:#a6e22e">client</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">readyState</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">WebSocket</span>.<span style="color:#a6e22e">OPEN</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">send</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">user</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">text</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">timestamp</span><span style="color:#f92672">:</span> Date.<span style="color:#a6e22e">now</span>(),
</span></span><span style="display:flex;"><span>          })
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;close&#34;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Client đã ngắt kết nối&#34;</span>);
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// Server-side WebSocket với Java (JSR 356)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.websocket.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.websocket.server.ServerEndpoint;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ServerEndpoint</span>(<span style="color:#e6db74">&#34;/chat&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChatEndpoint</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Set<span style="color:#f92672">&lt;</span>Session<span style="color:#f92672">&gt;</span> sessions <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@OnOpen</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onOpen</span>(Session session) {
</span></span><span style="display:flex;"><span>        sessions.<span style="color:#a6e22e">add</span>(session);
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Client đã kết nối: &#34;</span> <span style="color:#f92672">+</span> session.<span style="color:#a6e22e">getId</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@OnMessage</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onMessage</span>(String message, Session session) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Phát tin nhắn đến tất cả clients</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (Session s : sessions) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (s.<span style="color:#a6e22e">isOpen</span>()) {
</span></span><span style="display:flex;"><span>                s.<span style="color:#a6e22e">getAsyncRemote</span>().<span style="color:#a6e22e">sendText</span>(message);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@OnClose</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onClose</span>(Session session) {
</span></span><span style="display:flex;"><span>        sessions.<span style="color:#a6e22e">remove</span>(session);
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Client đã ngắt kết nối: &#34;</span> <span style="color:#f92672">+</span> session.<span style="color:#a6e22e">getId</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="so-sánh-từ-góc-nhìn-tầng-mạng">So sánh từ góc nhìn tầng mạng</h2>
<p>Khi đặt ba cơ chế lên bàn cân, sự khác biệt ở tầng mạng rất rõ ràng. HTTP Polling tạo ra một kết nối mới cho mỗi yêu cầu (hoặc tái sử dụng kết nối nếu dùng Keep-Alive), gửi toàn bộ HTTP headers, nhận phản hồi, rồi đóng hoặc trả kết nối về nhóm. Chi phí phụ của quá trình bắt tay TCP và phân tích HTTP lặp đi lặp lại là không thể chấp nhận với quy mô lớn.</p>
<p>Long Polling cải thiện bằng cách giữ kết nối lâu hơn, nhưng chu kỳ yêu cầu-phản hồi vẫn tồn tại. Server phải giữ kết nối trong trạng thái chờ, tiêu tốn bộ nhớ cho mỗi kết nối. Khi sự kiện xảy ra, kết nối đóng và client phải tạo yêu cầu mới ngay lập tức, dẫn đến một loạt quá trình bắt tay TCP và chi phí phụ HTTP không cần thiết.</p>
<p>SSE giữ một kết nối bền vững, tránh được chi phí phụ của việc thiết lập kết nối. Dữ liệu được gửi qua cùng một kết nối TCP dưới dạng luồng văn bản với chi phí phụ tối thiểu. Tuy nhiên, giao tiếp vẫn là một chiều. Client gửi dữ liệu lên server phải dùng các yêu cầu HTTP riêng, không thể ghép kênh qua cùng kết nối.</p>
<p>WebSocket thắng áp đảo về mặt hiệu quả. Một kết nối TCP duy nhất được thiết lập qua quá trình bắt tay HTTP, sau đó chuyển sang giao thức nhị phân với chi phí phụ khung chỉ 2-14 bytes. Không có HTTP headers cho mỗi tin nhắn. Cả hai chiều đều có thể gửi dữ liệu đồng thời mà không chờ đợi. Độ trễ giảm vì không có vòng qua yêu cầu-phản hồi.</p>
<p>Về việc sử dụng tài nguyên phía server, WebSocket có vẻ tốn kém vì mỗi kết nối cần một mô tả socket và một ít bộ nhớ cho buffers. Nhưng khi so sánh với Long Polling (mỗi client cũng chiếm một kết nối đang chờ), WebSocket thực ra hiệu quả hơn vì không cần liên tục tạo yêu cầu mới và xử lý chi phí phụ giao thức HTTP.</p>
<h2 id="độ-trễ-và-trải-nghiệm-người-dùng">Độ trễ và trải nghiệm người dùng</h2>
<p>Độ trễ là yếu tố quyết định trải nghiệm người dùng trong các ứng dụng thời gian thực. Với thăm dò, độ trễ tệ nhất bằng khoảng thời gian thăm dò. Nếu thăm dò mỗi 2 giây, người dùng có thể phải đợi gần 2 giây để thấy cập nhật. Giảm khoảng thời gian xuống 500ms thì cải thiện độ trễ nhưng lại tăng tải server gấp 4 lần.</p>
<p>Long Polling về lý thuyết có độ trể thấp vì server phản hồi ngay khi có sự kiện. Nhưng trong thực tế, việc đóng kết nối và tạo yêu cầu mới mất thời gian. Client phải đợi yêu cầu trước hoàn thành, phân tích phản hồi, rồi mới tạo yêu cầu tiếp theo. Nếu sự kiện xảy ra liên tục, client có thể bỏ lỡ sự kiện vì đang trong quá trình tạo yêu cầu mới.</p>
<p>SSE có độ trễ gần như thời gian thực vì kết nối luôn mở và server đẩy ngay khi có sự kiện. Nhưng hướng ngược lại vẫn phải qua yêu cầu HTTP, tăng độ trễ cho tương tác hai chiều.</p>
<p>WebSocket đạt độ trễ thấp nhất. Tin nhắn được gửi trực tiếp qua socket TCP mà không qua xử lý HTTP. Không có thiết lập kết nối, không có hàng đợi yêu cầu. Khi người dùng nhấn gửi, tin nhắn đến server trong vài chục mili giây tùy điều kiện mạng, và phản hồi về ngay lập tức.</p>
<p>Đã có thử nghiệm ba cơ chế này trên cùng một ứng dụng chat. Với 1000 người dùng đồng thời gửi tin nhắn với tần suất trung bình 1 tin nhắn/phút, thăm dò (khoảng 2 giây) có độ trễ trung bình 1.2 giây và CPU server 45%. Long Polling giảm độ trễ xuống 200ms nhưng CPU vẫn ở 30% do xử lý kết nối. WebSocket chỉ có độ trễ 50ms với việc sử dụng CPU dưới 10%. Sự khác biệt không thể rõ ràng hơn.</p>
<h2 id="tình-huống-thực-tế-và-lựa-chọn-công-nghệ">Tình huống thực tế và lựa chọn công nghệ</h2>
<p>Ứng dụng chat thời gian thực là trường hợp rõ ràng nhất cho WebSocket. Người dùng cần thấy tin nhắn ngay lập tức, và cả hai phía đều liên tục gửi dữ liệu. WebSocket cung cấp độ trễ thấp nhất và hiệu quả băng thông tốt nhất. Ứng dụng chat với WebSocket cho trải nghiệm mượt mà như các ứng dụng nhắn tin gốc. Tin nhắn đến trong vòng 100ms, chỉ báo đang gõ hoạt động hoàn hảo, và server xử lý được vài nghìn kết nối đồng thời mà không vấn đề gì.</p>
<p>Bảng điều khiển trực tiếp và hệ thống giám sát cũng được lợi nhiều từ WebSocket hoặc SSE. Nếu bảng điều khiển chỉ cần hiển thị dữ liệu mà không gửi lệnh lên server, SSE là lựa chọn đơn giản và hiệu quả. Nhưng nếu người dùng cần tương tác với bảng điều khiển (lọc dữ liệu, gửi lệnh), WebSocket linh hoạt hơn vì giao tiếp hai chiều.</p>
<p>Hệ thống thông báo có thể dùng SSE hoặc WebSocket. SSE đơn giản hơn và hỗ trợ trình duyệt tốt. Nhưng nếu ứng dụng đã dùng WebSocket cho tính năng khác, việc tái sử dụng kết nối cho thông báo sẽ tiết kiệm tài nguyên hơn duy trì hai loại kết nối riêng biệt.</p>
<p>Công cụ chỉnh sửa cộng tác như Google Docs hoàn toàn cần WebSocket. Mỗi lần gõ phím phải được đồng bộ với độ trễ cực thấp. Các thuật toán Operational Transform hoặc CRDT yêu cầu đồng bộ hai chiều liên tục. Thăm dò hoặc SSE đơn giản không đủ nhanh.</p>
<p>Trò chơi và ứng dụng nhiều người chơi cũng vậy. Hành động của người chơi cần được phản ánh ngay lập tức. WebSocket cung cấp kênh hai chiều độ trễ thấp cần thiết. Thậm chí nhiều trò chơi chuyển sang WebRTC cho kết nối ngang hàng, nhưng tín hiệu vẫn qua WebSocket.</p>
<p>Còn những trường hợp nào nên dùng thăm dò? Thực ra rất ít. Một trường hợp hợp lý là khi cần hỗ trợ trình duyệt cũ hoặc tường lửa doanh nghiệp chặn WebSocket. HTTP Polling luôn hoạt động vì nó chỉ là các yêu cầu HTTP thông thường. Nhưng đó là sự đánh đổi phải chấp nhận cho khả năng tương thích, không phải vì hiệu năng.</p>
<h2 id="khi-nào-nên-dùng-cái-nào">Khi nào nên dùng cái nào</h2>
<p>Sau nhiều năm làm việc với các hệ thống thời gian thực, có thể rút ra kinh nghiệm sau. Nếu ứng dụng cần giao tiếp thời gian thực hai chiều với độ trễ thấp, WebSocket là lựa chọn mặc định. Chat, trò chơi, công cụ cộng tác, nền tảng giao dịch trực tiếp đều thuộc nhóm này.</p>
<p>Nếu ứng dụng chỉ cần server đẩy dữ liệu xuống client mà không cần client gửi dữ liệu liên tục, SSE là tùy chọn đơn giản và đủ dùng. Thông báo trực tiếp, bảng giá cổ phiếu, nguồn tin tức, bảng điều khiển giám sát chỉ hiển thị dữ liệu đều hoạt động tốt với SSE. Điểm cộng là SSE tự động kết nối lại khi kết nối đứt, không cần code thêm.</p>
<p>Thăm dò chỉ nên dùng khi không có lựa chọn nào khác. Hệ thống cũ, môi trường không hỗ trợ WebSocket, hoặc khi tần suất cập nhật thực sự thấp (vài phút một lần) thì thăm dó chấp nhận được. Nhưng hãy nhớ rằng nó không mở rộng tốt và lãng phí tài nguyên.</p>
<p>Một cách tiếp cận thường dùng là kết hợp lai. WebSocket cho các tính năng thời gian thực chính, dự phòng về Long Polling nếu WebSocket không khả dụng (do tường lửa hoặc proxy). Các thư viện như Socket.IO đã triển khai sẵn cơ chế dự phòng tự động này. Bắt đầu với WebSocket, nếu quá trình bắt tay thất bại, thử Long Polling, cuối cùng mới xuống thăm dò thông thường.</p>
<h2 id="kết-luận">Kết luận</h2>
<p>WebSocket không phải là giải pháp vạn năng cho mọi vấn đề, nhưng nó chắc chắn là giải pháp tốt nhất cho giao tiếp thời gian thực. Việc hiểu rõ cách WebSocket hoạt động ở tầng mạng, từ quá trình bắt tay HTTP đến kết nối song công toàn phần TCP, giúp gỡ lỗi vấn đề và tối ưu hiệu năng hiệu quả hơn.</p>
<p>HTTP Polling và Long Polling là những giải pháp tình thế từ thời WebSocket chưa được hỗ trợ rộng rãi. Giờ đây với hỗ trợ trình duyệt gần như toàn cầu, không còn lý do để chịu đựng chi phí phụ và độ trễ của thăm dò nữa. SSE là điểm cân bằng tốt cho giao tiếp một chiều, đơn giản hơn WebSocket nhưng vẫn hiệu quả.</p>
<p>Khi thiết kế các hệ thống thời gian thực, hãy nghĩ về hướng luồng dữ liệu, yêu cầu độ trễ, và kỳ vọng quy mô. Những yếu tố này sẽ định hướng đến lựa chọn công nghệ đúng đắn. Đừng ngại triển khai và đo đạc các tùy chọn khác nhau. Hiệu năng thực tế thường khác xa phân tích lý thuyết, và chỉ có kiểm thử mới cho con số chính xác.</p>
<hr>
<p><strong>Tham khảo:</strong></p>
<ul>
<li>RFC 6455 (WebSocket Protocol)</li>
<li>MDN Web Docs: WebSocket API</li>
<li>&ldquo;High Performance Browser Networking&rdquo; - Ilya Grigorik</li>
<li>Socket.IO Documentation</li>
</ul>

        </div>
      </article>
    </div>

    
    <div class="lg:col-span-3">
<div
  class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-lg shadow-lg p-6"
>
  
  
  <div class="text-center mb-4">
    <img
      src="/images/avatar.jpg"
      alt="Lý Thuận An"
      class="w-48 h-48 rounded-lg mx-auto object-cover shadow-md border-4 border-slate-700"
    />
  </div>
  

  
  <h3
    class="text-lg font-bold mb-2 text-white text-center flex items-center justify-center"
  >
    <svg
      class="w-5 h-5 mr-2 text-cyan-400"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
      ></path>
    </svg>
    ABOUT ME
  </h3>

  
  <div class="space-y-3">
    
    
    <div class="text-center">
      <h4 class="font-bold text-white text-xl">
        Lý Thuận An
      </h4>
    </div>
    

    
    
    <p class="text-gray-400 text-sm text-center leading-relaxed italic">
      Engineer #Pencraft Cloud, Open Source Enthusiast and Life Adventurer
    </p>
    

    
    
    <p class="text-gray-300 leading-relaxed text-sm">
      Mình là Lý Thuận An, đang theo học năm cuối chuyên ngành Trí tuệ nhân tạo tại Đại học Công nghệ TP.HCM (HUTECH). Định hướng nghề nghiệp của mình tập trung vào việc kết nối nghiên cứu AI với phát triển ứng dụng thực tế.
    </p>
    

    
    <div class="space-y-2 pt-2">
      
      <a
        href="mailto:anly1704@gmail.com"
        class="flex items-center text-gray-300 hover:text-cyan-400 transition-colors text-sm"
      >
        <svg
          class="w-4 h-4 mr-2 text-cyan-400"
          fill="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"
          />
        </svg>
        anly1704@gmail.com
      </a>
       
      <div class="flex items-center text-gray-300 text-sm">
        <svg
          class="w-4 h-4 mr-2 text-cyan-400"
          fill="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"
          />
        </svg>
        &#43;84 769 339 058
      </div>
      
    </div>

    
    <div class="flex items-center justify-center gap-3 pt-3">
      
      <a
        href="https://github.com/aresu-1704"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center justify-center w-10 h-10 bg-gray-700 hover:bg-gray-600 text-white rounded-full transition-all duration-200 hover:scale-110"
        title="GitHub"
      >
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
          />
        </svg>
      </a>
       
      <a
        href="https://www.facebook.com/an.thuan.3139241"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center justify-center w-10 h-10 bg-blue-600 hover:bg-blue-500 text-white rounded-full transition-all duration-200 hover:scale-110"
        title="Facebook"
      >
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"
          />
        </svg>
      </a>
      
    </div>
  </div>
  
</div>
</div>
  </div>
</div>
</main>

    
    <footer
      class="bg-slate-950 text-gray-400 py-8 mt-12 border-t border-slate-800"
    >
      <div class="container mx-auto px-4 text-center">
        <p>&copy; 2025 THUẬN AN IT BLOG. All rights reserved.</p>
      </div>
    </footer>

    
    <script src="/js/search.js"></script>
  </body>
</html>
