<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Hướng dẫn xây dựng ứng dụng Chat nâng cao sử dụng TCP trong Java nâng cao bằng Multi-threads"
    />
    <title>
      Ứng dụng Chat sử dụng TCP trong Java (Phần 2) - THUẬN AN IT BLOG
    </title>

    
    
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    

    
    <script src="https://cdn.tailwindcss.com"></script>

    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
              },
            },
          },
        },
      };
    </script>

    
     
    <link rel="stylesheet" href="http://localhost:1313/css/main.css" />
    
  </head>
  <body class="bg-slate-900 text-gray-100">
    
    
<nav class="bg-slate-950 border-b border-slate-800 shadow-lg sticky top-0 z-50">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-between h-16">
      
      <a
        href="/"
        class="text-xl font-bold text-cyan-400 hover:text-cyan-300 transition-colors"
      >
        THUẬN AN IT BLOG
      </a>

      
      <div class="hidden md:flex items-center space-x-8">
        
        <a
          href="/"
          class="text-gray-300 hover:text-cyan-400 transition-colors font-medium"
        >
          Home
        </a>

        
        <div class="relative group">
          <button
            class="text-gray-300 hover:text-cyan-400 transition-colors font-medium flex items-center"
          >
            Categories
            <svg
              class="w-4 h-4 ml-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </button>

          
          <div
            class="absolute left-0 mt-2 w-48 bg-slate-800 border border-slate-700 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200"
          >
            <div class="py-2">
              
              <a
                href="http://localhost:1313/categories/backend/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors"
              >
                Backend
                <span class="text-gray-500 text-sm">(1)</span>
              </a>
              
              <a
                href="http://localhost:1313/categories/java/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors"
              >
                Java
                <span class="text-gray-500 text-sm">(6)</span>
              </a>
              
              <a
                href="http://localhost:1313/categories/javascript/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors"
              >
                JavaScript
                <span class="text-gray-500 text-sm">(3)</span>
              </a>
              
              <a
                href="http://localhost:1313/categories/network/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors"
              >
                Network
                <span class="text-gray-500 text-sm">(2)</span>
              </a>
              
              <a
                href="http://localhost:1313/categories/network-programming/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors"
              >
                Network Programming
                <span class="text-gray-500 text-sm">(2)</span>
              </a>
              
              <a
                href="http://localhost:1313/categories/networking/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors"
              >
                Networking
                <span class="text-gray-500 text-sm">(4)</span>
              </a>
              
              <a
                href="http://localhost:1313/categories/programming/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors"
              >
                Programming
                <span class="text-gray-500 text-sm">(4)</span>
              </a>
              
              <a
                href="http://localhost:1313/categories/security/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors"
              >
                Security
                <span class="text-gray-500 text-sm">(1)</span>
              </a>
              
              <a
                href="http://localhost:1313/categories/system-design/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors"
              >
                System Design
                <span class="text-gray-500 text-sm">(1)</span>
              </a>
              
              <a
                href="http://localhost:1313/categories/web-development/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors"
              >
                Web Development
                <span class="text-gray-500 text-sm">(1)</span>
              </a>
              
              <a
                href="http://localhost:1313/categories/web-security/"
                class="block px-4 py-2 text-gray-300 hover:bg-slate-700 hover:text-cyan-400 transition-colors"
              >
                Web Security
                <span class="text-gray-500 text-sm">(1)</span>
              </a>
              
            </div>
          </div>
        </div>

        
        <a
          href="/categories/"
          class="text-gray-300 hover:text-cyan-400 transition-colors font-medium"
        >
          Tất cả danh mục
        </a>
      </div>

      
      <button
        id="mobile-menu-button"
        class="md:hidden text-gray-300 hover:text-cyan-400 focus:outline-none"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"
          ></path>
        </svg>
      </button>
    </div>

    
    <div id="mobile-menu" class="hidden md:hidden pb-4">
      <a
        href="/"
        class="block py-2 text-gray-300 hover:text-cyan-400 transition-colors font-medium"
      >
        Home
      </a>
      <div class="py-2">
        <div class="font-medium text-white mb-2">Categories:</div>
        
        <a
          href="http://localhost:1313/categories/backend/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Backend
          <span class="text-gray-500 text-sm">(1)</span>
        </a>
        
        <a
          href="http://localhost:1313/categories/java/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Java
          <span class="text-gray-500 text-sm">(6)</span>
        </a>
        
        <a
          href="http://localhost:1313/categories/javascript/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          JavaScript
          <span class="text-gray-500 text-sm">(3)</span>
        </a>
        
        <a
          href="http://localhost:1313/categories/network/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Network
          <span class="text-gray-500 text-sm">(2)</span>
        </a>
        
        <a
          href="http://localhost:1313/categories/network-programming/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Network Programming
          <span class="text-gray-500 text-sm">(2)</span>
        </a>
        
        <a
          href="http://localhost:1313/categories/networking/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Networking
          <span class="text-gray-500 text-sm">(4)</span>
        </a>
        
        <a
          href="http://localhost:1313/categories/programming/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Programming
          <span class="text-gray-500 text-sm">(4)</span>
        </a>
        
        <a
          href="http://localhost:1313/categories/security/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Security
          <span class="text-gray-500 text-sm">(1)</span>
        </a>
        
        <a
          href="http://localhost:1313/categories/system-design/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          System Design
          <span class="text-gray-500 text-sm">(1)</span>
        </a>
        
        <a
          href="http://localhost:1313/categories/web-development/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Web Development
          <span class="text-gray-500 text-sm">(1)</span>
        </a>
        
        <a
          href="http://localhost:1313/categories/web-security/"
          class="block py-1 pl-4 text-gray-300 hover:text-cyan-400 transition-colors"
        >
          Web Security
          <span class="text-gray-500 text-sm">(1)</span>
        </a>
        
      </div>
      <a
        href="/categories/"
        class="block py-2 text-gray-300 hover:text-cyan-400 transition-colors font-medium"
      >
        Tất cả danh mục
      </a>
    </div>
  </div>
</nav>


<script>
  document
    .getElementById("mobile-menu-button")
    .addEventListener("click", function () {
      const menu = document.getElementById("mobile-menu");
      menu.classList.toggle("hidden");
    });
</script>


    
    <main class="min-h-screen">
<div class="container mx-auto px-4 py-8">
  <div class="grid grid-cols-1 lg:grid-cols-10 gap-8">
    
    <div class="lg:col-span-7">
      <article
        class="bg-slate-800 border border-slate-700 rounded-lg shadow-lg p-8"
      >
        
        <header class="mb-8">
          
          
          <div class="mb-6 -mx-8 -mt-8">
            <img
              src="images/multi-thread-example.jpg"
              alt="Ứng dụng Chat sử dụng TCP trong Java (Phần 2)"
              class="w-full h-64 object-cover rounded-t-lg"
            />
          </div>
          

          <h1 class="text-4xl font-bold mb-4 text-white">Ứng dụng Chat sử dụng TCP trong Java (Phần 2)</h1>

          <div
            class="flex flex-wrap items-center gap-4 text-sm text-gray-400 mb-4"
          >
            
            <span class="flex items-center">
              <svg
                class="w-4 h-4 mr-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                ></path>
              </svg>
              20/12/2025
            </span>

            
            
            <span class="flex items-center">
              <svg
                class="w-4 h-4 mr-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
              Thuận An
            </span>
            
          </div>

          
          
          <div class="flex flex-wrap gap-2 mb-4">
            
            <a
              href="/categories/programming"
              class="px-3 py-1 bg-cyan-900 bg-opacity-30 text-cyan-300 border border-cyan-600 rounded-full text-sm hover:bg-cyan-800 hover:bg-opacity-40 transition-colors"
            >
              Programming
            </a>
            
            <a
              href="/categories/java"
              class="px-3 py-1 bg-cyan-900 bg-opacity-30 text-cyan-300 border border-cyan-600 rounded-full text-sm hover:bg-cyan-800 hover:bg-opacity-40 transition-colors"
            >
              Java
            </a>
            
            <a
              href="/categories/networking"
              class="px-3 py-1 bg-cyan-900 bg-opacity-30 text-cyan-300 border border-cyan-600 rounded-full text-sm hover:bg-cyan-800 hover:bg-opacity-40 transition-colors"
            >
              Networking
            </a>
            
          </div>
          

          
          
          <div class="flex flex-wrap gap-2">
            
            <a
              href="/tags/java"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #Java
            </a>
            
            <a
              href="/tags/tcp/ip"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #TCP/IP
            </a>
            
            <a
              href="/tags/socket"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #Socket
            </a>
            
            <a
              href="/tags/client-server"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #Client-Server
            </a>
            
            <a
              href="/tags/network"
              class="px-3 py-1 bg-slate-700 text-gray-300 rounded-full text-sm hover:bg-slate-600 transition-colors"
            >
              #Network
            </a>
            
          </div>
          
        </header>

        
        <div
          class="prose prose-invert max-w-none prose-headings:font-bold prose-headings:text-white prose-a:text-cyan-400 prose-a:no-underline hover:prose-a:underline prose-img:rounded-lg prose-pre:bg-slate-950 prose-pre:border prose-pre:border-slate-700 prose-code:text-cyan-300 text-gray-300"
        >
          <p>Trong phần trước, chúng ta đã kết nối được Client và Server. Tuy nhiên, nó có một điểm yếu chết người: <strong>Blocking I/O</strong>. Khi code chạy lệnh <code>readLine()</code>, chương trình bị &ldquo;đơ&rdquo; để chờ tin nhắn, khiến bạn không thể gõ tin nhắn gửi đi trong lúc đang chờ nhận.</p>
<p>Để giải quyết, chúng ta cần sử dụng <strong>Threads (Luồng)</strong>.</p>
<ul>
<li><strong>Server</strong>: Cần một luồng chính để đón khách, và mỗi khi có khách (Client) mới, server sẽ tạo riêng một luồng con (Worker Thread) để phục vụ vị khách đó.</li>
<li><strong>Client</strong>: Cần tách việc &ldquo;Gửi tin&rdquo; và &ldquo;Nhận tin&rdquo; ra làm 2 luồng chạy song song.</li>
</ul>
<p>Dưới đây là mã nguồn chi tiết cho một hệ thống <strong>Chat Room hoàn chỉnh</strong>.</p>
<h2 id="1-xây-dựng-server-đa-luồng-chatserverjava">1. Xây dựng Server Đa Luồng (ChatServer.java)</h2>
<p>Server này có khả năng:</p>
<ul>
<li>Chấp nhận nhiều kết nối cùng lúc.</li>
<li>Lưu danh sách các người dùng đang online.</li>
<li>Khi một người nhắn, Server sẽ <strong>Broadcast</strong> (phát loa) tin nhắn đó tới tất cả những người khác.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChatServer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> port;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Set dùng để lưu danh sách các user unique, tránh trùng lặp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> userNames <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Set lưu trữ các luồng viết của từng client để broadcast tin nhắn</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Set<span style="color:#f92672">&lt;</span>UserThread<span style="color:#f92672">&gt;</span> userThreads <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ChatServer</span>(<span style="color:#66d9ef">int</span> port) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> port;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">execute</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> (ServerSocket serverSocket <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ServerSocket(port)) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Chat Server đang chạy trên cổng &#34;</span> <span style="color:#f92672">+</span> port);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Vòng lặp vô tận để liên tục chấp nhận kết nối mới</span>
</span></span><span style="display:flex;"><span>                Socket socket <span style="color:#f92672">=</span> serverSocket.<span style="color:#a6e22e">accept</span>();
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;New user connected&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Với mỗi user mới, tạo một Thread riêng để xử lý</span>
</span></span><span style="display:flex;"><span>                UserThread newUser <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> UserThread(socket, <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>                userThreads.<span style="color:#a6e22e">add</span>(newUser);
</span></span><span style="display:flex;"><span>                newUser.<span style="color:#a6e22e">start</span>(); <span style="color:#75715e">// Bắt đầu luồng</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Lỗi Server: &#34;</span> <span style="color:#f92672">+</span> ex.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>            ex.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>        ChatServer server <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ChatServer(5000);
</span></span><span style="display:flex;"><span>        server.<span style="color:#a6e22e">execute</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Gửi tin nhắn đến TẤT CẢ các user khác (Broadcast)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">broadcast</span>(String message, UserThread excludeUser) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (UserThread aUser : userThreads) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (aUser <span style="color:#f92672">!=</span> excludeUser) {
</span></span><span style="display:flex;"><span>                aUser.<span style="color:#a6e22e">sendMessage</span>(message);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Lưu tên user mới
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addUserName</span>(String userName) {
</span></span><span style="display:flex;"><span>        userNames.<span style="color:#a6e22e">add</span>(userName);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Xóa user khi họ thoát
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeUser</span>(String userName, UserThread aUser) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> removed <span style="color:#f92672">=</span> userNames.<span style="color:#a6e22e">remove</span>(userName);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (removed) {
</span></span><span style="display:flex;"><span>            userThreads.<span style="color:#a6e22e">remove</span>(aUser);
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;User &#34;</span> <span style="color:#f92672">+</span> userName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; đã thoát.&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getUserNames</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">userNames</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasUsers</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">userNames</span>.<span style="color:#a6e22e">isEmpty</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="server-helper-userthreadjava">Server Helper: UserThread.java</h3>
<p>Đây là lớp &ldquo;công nhân&rdquo; xử lý riêng cho từng kết nối.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserThread</span> <span style="color:#66d9ef">extends</span> Thread {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Socket socket;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ChatServer server;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> PrintWriter writer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">UserThread</span>(Socket socket, ChatServer server) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">socket</span> <span style="color:#f92672">=</span> socket;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">server</span> <span style="color:#f92672">=</span> server;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Setup luồng vào/ra</span>
</span></span><span style="display:flex;"><span>            InputStream input <span style="color:#f92672">=</span> socket.<span style="color:#a6e22e">getInputStream</span>();
</span></span><span style="display:flex;"><span>            BufferedReader reader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader(<span style="color:#66d9ef">new</span> InputStreamReader(input));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            OutputStream output <span style="color:#f92672">=</span> socket.<span style="color:#a6e22e">getOutputStream</span>();
</span></span><span style="display:flex;"><span>            writer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PrintWriter(output, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            printUsers();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Dòng đầu tiên client gửi sang sẽ là Tên</span>
</span></span><span style="display:flex;"><span>            String userName <span style="color:#f92672">=</span> reader.<span style="color:#a6e22e">readLine</span>();
</span></span><span style="display:flex;"><span>            server.<span style="color:#a6e22e">addUserName</span>(userName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            String serverMessage <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;User mới tham gia: &#34;</span> <span style="color:#f92672">+</span> userName;
</span></span><span style="display:flex;"><span>            server.<span style="color:#a6e22e">broadcast</span>(serverMessage, <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Vòng lặp chat</span>
</span></span><span style="display:flex;"><span>            String clientMessage;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>                clientMessage <span style="color:#f92672">=</span> reader.<span style="color:#a6e22e">readLine</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (clientMessage <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                    serverMessage <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;[&#34;</span> <span style="color:#f92672">+</span> userName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]: &#34;</span> <span style="color:#f92672">+</span> clientMessage;
</span></span><span style="display:flex;"><span>                    server.<span style="color:#a6e22e">broadcast</span>(serverMessage, <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>clientMessage.<span style="color:#a6e22e">equals</span>(<span style="color:#e6db74">&#34;bye&#34;</span>)); <span style="color:#75715e">// Gõ &#39;bye&#39; để thoát</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            server.<span style="color:#a6e22e">removeUser</span>(userName, <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>            socket.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            serverMessage <span style="color:#f92672">=</span> userName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; đã rời phòng chat.&#34;</span>;
</span></span><span style="display:flex;"><span>            server.<span style="color:#a6e22e">broadcast</span>(serverMessage, <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Lỗi trong UserThread: &#34;</span> <span style="color:#f92672">+</span> ex.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Gửi danh sách người đang online cho người mới vào
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printUsers</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (server.<span style="color:#a6e22e">hasUsers</span>()) {
</span></span><span style="display:flex;"><span>            writer.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Đang online: &#34;</span> <span style="color:#f92672">+</span> server.<span style="color:#a6e22e">getUserNames</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            writer.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Chưa có ai online.&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Hàm gửi tin nhắn xuống Client của thread này
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sendMessage</span>(String message) {
</span></span><span style="display:flex;"><span>        writer.<span style="color:#a6e22e">println</span>(message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="2-xây-dựng-client-bất-đồng-bộ-chatclientjava">2. Xây dựng Client Bất đồng bộ (ChatClient.java)</h2>
<p>Ở phía Client, chúng ta cần tách việc <strong>Đọc (Read)</strong> và <strong>Ghi (Write)</strong> ra làm 2 luồng riêng biệt để chúng không chặn nhau.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChatClient</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String hostname;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> port;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String userName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ChatClient</span>(String hostname, <span style="color:#66d9ef">int</span> port) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">hostname</span> <span style="color:#f92672">=</span> hostname;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> port;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">execute</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            Socket socket <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Socket(hostname, port);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Đã kết nối vào phòng chat!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Thread 1: Chuyên nghe tin nhắn từ Server</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> ReadThread(socket, <span style="color:#66d9ef">this</span>).<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Thread 2: Chuyên gửi tin nhắn đi (Main thread)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> WriteThread(socket, <span style="color:#66d9ef">this</span>).<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (UnknownHostException ex) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Không tìm thấy Server: &#34;</span> <span style="color:#f92672">+</span> ex.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Lỗi I/O: &#34;</span> <span style="color:#f92672">+</span> ex.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setUserName</span>(String userName) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">userName</span> <span style="color:#f92672">=</span> userName;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    String <span style="color:#a6e22e">getUserName</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">userName</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>        ChatClient client <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ChatClient(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, 5000);
</span></span><span style="display:flex;"><span>        client.<span style="color:#a6e22e">execute</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="client-helper-1-readthreadjava-luồng-đọc">Client Helper 1: ReadThread.java (Luồng Đọc)</h3>
<p>Nhiệm vụ: Liên tục lắng nghe xem có tin nhắn mới từ Server không và in ra màn hình.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReadThread</span> <span style="color:#66d9ef">extends</span> Thread {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> BufferedReader reader;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Socket socket;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ChatClient client;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ReadThread</span>(Socket socket, ChatClient client) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">socket</span> <span style="color:#f92672">=</span> socket;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> client;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            InputStream input <span style="color:#f92672">=</span> socket.<span style="color:#a6e22e">getInputStream</span>();
</span></span><span style="display:flex;"><span>            reader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader(<span style="color:#66d9ef">new</span> InputStreamReader(input));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Lỗi lấy Input Stream: &#34;</span> <span style="color:#f92672">+</span> ex.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>            ex.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                String response <span style="color:#f92672">=</span> reader.<span style="color:#a6e22e">readLine</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (response <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;\nServer đã ngắt kết nối.&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// In tin nhắn từ người khác ra màn hình</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Dùng \r để đưa con trỏ về đầu dòng (trick giao diện)</span>
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;\n&#34;</span> <span style="color:#f92672">+</span> response); 
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// In lại dấu nhắc nhập liệu để người dùng biết mình đang ở đâu</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (client.<span style="color:#a6e22e">getUserName</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;[&#34;</span> <span style="color:#f92672">+</span> client.<span style="color:#a6e22e">getUserName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]: &#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Lỗi đọc dữ liệu: &#34;</span> <span style="color:#f92672">+</span> ex.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="client-helper-2-writethreadjava-luồng-ghi">Client Helper 2: WriteThread.java (Luồng Ghi)</h3>
<p>Nhiệm vụ: Đọc từ bàn phím người dùng và gửi sang Server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Scanner;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WriteThread</span> <span style="color:#66d9ef">extends</span> Thread {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> PrintWriter writer;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Socket socket;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ChatClient client;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">WriteThread</span>(Socket socket, ChatClient client) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">socket</span> <span style="color:#f92672">=</span> socket;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> client;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            OutputStream output <span style="color:#f92672">=</span> socket.<span style="color:#a6e22e">getOutputStream</span>();
</span></span><span style="display:flex;"><span>            writer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PrintWriter(output, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Lỗi lấy Output Stream: &#34;</span> <span style="color:#f92672">+</span> ex.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>            ex.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Nếu chạy trong IDE (Eclipse/IntelliJ) thì Console có thể null, fallback về Scanner</span>
</span></span><span style="display:flex;"><span>        Scanner scanner <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Scanner(System.<span style="color:#a6e22e">in</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;Nhập tên của bạn: &#34;</span>);
</span></span><span style="display:flex;"><span>        String userName <span style="color:#f92672">=</span> scanner.<span style="color:#a6e22e">nextLine</span>();
</span></span><span style="display:flex;"><span>        client.<span style="color:#a6e22e">setUserName</span>(userName);
</span></span><span style="display:flex;"><span>        writer.<span style="color:#a6e22e">println</span>(userName); <span style="color:#75715e">// Gửi tên lên server đầu tiên</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String text;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;[&#34;</span> <span style="color:#f92672">+</span> userName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]: &#34;</span>);
</span></span><span style="display:flex;"><span>            text <span style="color:#f92672">=</span> scanner.<span style="color:#a6e22e">nextLine</span>();
</span></span><span style="display:flex;"><span>            writer.<span style="color:#a6e22e">println</span>(text);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>text.<span style="color:#a6e22e">equals</span>(<span style="color:#e6db74">&#34;bye&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            socket.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Lỗi khi ghi dữ liệu: &#34;</span> <span style="color:#f92672">+</span> ex.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="3-phân-tích-kỹ-thuật-technical-deep-dive">3. Phân tích kỹ thuật (Technical Deep Dive)</h2>
<h3 id="tại-sao-lại-cần-setuserthread">Tại sao lại cần Set&lt;UserThread&gt;?</h3>
<p>Trong file <code>ChatServer.java</code>, tôi sử dụng <code>Set</code> thay vì <code>List</code>.</p>
<p><strong>Lý do</strong>: Chúng ta cần đảm bảo danh sách kết nối là duy nhất. <code>Set</code> giúp quản lý việc thêm/xóa user nhanh hơn và tránh việc gửi tin nhắn 2 lần cho cùng một người nếu code có lỗi logic.</p>
<h3 id="logic-của-hàm-broadcast">Logic của hàm broadcast()</h3>
<p>Đây là <strong>trái tim</strong> của Chat Room.</p>
<ol>
<li>Server nhận tin từ User A.</li>
<li>Server lặp qua danh sách <code>Set&lt;UserThread&gt;</code> (chứa User A, B, C&hellip;).</li>
<li>Nó kiểm tra <code>if (aUser != excludeUser)</code>: Nếu người trong danh sách không phải là người vừa gửi tin (User A), thì gửi tin nhắn đó đi. Điều này tránh việc User A tự nhận lại tin nhắn mình vừa gửi.</li>
</ol>
<h3 id="vấn-đề-concurrency-đồng-thời">Vấn đề Concurrency (Đồng thời)</h3>
<p>Trong mã nguồn trên, tôi đã tối giản để dễ hiểu. Tuy nhiên trong môi trường <strong>Production</strong> thực tế, biến <code>userNames</code> và <code>userThreads</code> nên được thay thế bằng <code>Collections.synchronizedSet(...)</code> hoặc <code>ConcurrentHashMap</code> để tránh lỗi <strong>Race Condition</strong> (Tranh chấp luồng) khi có 2 người cùng thoát ra hoặc cùng đăng nhập chính xác tại một thời điểm.</p>
<h2 id="4-chạy-thử-nghiệm">4. Chạy thử nghiệm</h2>
<p>Để thấy điều kỳ diệu (Chat nhiều người), hãy làm như sau:</p>
<ol>
<li><strong>Chạy Server</strong>: Chạy file <code>ChatServer.java</code>.</li>
<li><strong>Chạy Client 1</strong>: Chạy file <code>ChatClient.java</code>, nhập tên là &ldquo;Tùng&rdquo;.</li>
<li><strong>Chạy Client 2</strong>: Mở thêm một Terminal khác, chạy <code>ChatClient.java</code>, nhập tên là &ldquo;Cúc&rdquo;.</li>
<li><strong>Chạy Client 3</strong>: Mở thêm Terminal nữa, chạy <code>ChatClient.java</code>, nhập tên là &ldquo;Trúc&rdquo;.</li>
</ol>
<p>Bây giờ khi &ldquo;Tùng&rdquo; nhắn <strong>&ldquo;Hello mọi người&rdquo;</strong>, cả &ldquo;Cúc&rdquo; và &ldquo;Trúc&rdquo; đều sẽ nhận được tin nhắn ngay lập tức. &ldquo;Cúc&rdquo; có thể trả lời trong khi &ldquo;Trúc&rdquo; đang gõ phím mà không ai bị chặn cả.</p>
<h2 id="5-lời-kết">5. Lời kết</h2>
<p>Việc xây dựng một ứng dụng Chat đa luồng là bước nhảy vọt quan trọng trong hành trình học lập trình mạng. Bạn đã học được:</p>
<ul>
<li><strong>Multi-threading</strong>: Cách tạo và quản lý nhiều luồng chạy song song.</li>
<li><strong>Broadcast Pattern</strong>: Cách gửi tin nhắn tới nhiều người cùng lúc.</li>
<li><strong>Non-blocking I/O concept</strong>: Tách việc đọc và ghi để giao diện không bị &ldquo;đơ&rdquo;.</li>
<li><strong>Real-time Communication</strong>: Nguyên lý cơ bản đằng sau các ứng dụng chat hiện đại.</li>
</ul>
<p>Từ đây, bạn có thể mở rộng thêm nhiều tính năng thú vị:</p>
<ul>
<li><strong>Private Message</strong>: Tin nhắn riêng giữa 2 người.</li>
<li><strong>Chat Rooms</strong>: Tạo nhiều phòng chat khác nhau.</li>
<li><strong>File Transfer</strong>: Gửi file qua lại.</li>
<li><strong>Encryption</strong>: Mã hóa tin nhắn để bảo mật.</li>
<li><strong>GUI Interface</strong>: Xây dựng giao diện đồ họa với JavaFX hoặc Swing.</li>
</ul>
<p>Hãy thử thách bản thân bằng cách implement những tính năng này! Networking không khó, chỉ cần luyện tập đủ nhiều, bạn sẽ thành thạo.</p>
<p>Happy coding!</p>

        </div>
      </article>
    </div>

    
    <div class="lg:col-span-3">
<div
  class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-lg shadow-lg p-6"
>
  
  
  <div class="text-center mb-4">
    <img
      src="/images/avatar.jpg"
      alt="Lý Thuận An"
      class="w-32 h-32 rounded-lg mx-auto object-cover shadow-md border-4 border-slate-700"
    />
  </div>
  

  
  <h3
    class="text-lg font-bold mb-2 text-white text-center flex items-center justify-center"
  >
    <svg
      class="w-5 h-5 mr-2 text-cyan-400"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
      ></path>
    </svg>
    ABOUT ME
  </h3>

  
  <div class="space-y-3">
    
    
    <div class="text-center">
      <h4 class="font-bold text-white text-xl">
        Lý Thuận An
      </h4>
    </div>
    

    
    
    <p class="text-gray-400 text-sm text-center leading-relaxed italic">
      Engineer #Pencraft Cloud, Open Source Enthusiast and Life Adventurer
    </p>
    

    
    
    <p class="text-gray-300 leading-relaxed text-sm">
      Mình là Lý Thuận An, đang theo học năm cuối chuyên ngành Trí tuệ nhân tạo tại Đại học Công nghệ TP.HCM (HUTECH). Định hướng nghề nghiệp của mình tập trung vào việc kết nối nghiên cứu AI với phát triển ứng dụng thực tế.
    </p>
    

    
    <div class="space-y-2 pt-2">
      
      <a
        href="mailto:anly1704@gmail.com"
        class="flex items-center text-gray-300 hover:text-cyan-400 transition-colors text-sm"
      >
        <svg
          class="w-4 h-4 mr-2 text-cyan-400"
          fill="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"
          />
        </svg>
        anly1704@gmail.com
      </a>
       
      <div class="flex items-center text-gray-300 text-sm">
        <svg
          class="w-4 h-4 mr-2 text-cyan-400"
          fill="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"
          />
        </svg>
        &#43;84 769 339 058
      </div>
      
    </div>

    
    <div class="flex items-center justify-center gap-3 pt-3">
      
      <a
        href="https://github.com/aresu-1704"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center justify-center w-10 h-10 bg-gray-700 hover:bg-gray-600 text-white rounded-full transition-all duration-200 hover:scale-110"
        title="GitHub"
      >
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
          />
        </svg>
      </a>
       
      <a
        href="https://www.facebook.com/an.thuan.3139241"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center justify-center w-10 h-10 bg-blue-600 hover:bg-blue-500 text-white rounded-full transition-all duration-200 hover:scale-110"
        title="Facebook"
      >
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"
          />
        </svg>
      </a>
      
    </div>
  </div>
  
</div>
</div>
  </div>
</div>
</main>

    
    <footer
      class="bg-slate-950 text-gray-400 py-8 mt-12 border-t border-slate-800"
    >
      <div class="container mx-auto px-4 text-center">
        <p>&copy; 2025 THUẬN AN IT BLOG. All rights reserved.</p>
      </div>
    </footer>

    
    <script src="/js/search.js"></script>
  </body>
</html>
